<div class="common-card">
    <mat-icon class="common-card-icon">receipt</mat-icon>
    <div class="order-header">
        <h3 class="common-name">{{ order?.DisplayName || order?.OrderId}}</h3>
        <div class="status-indicator" [ngClass]="getStatusClass(order?.Status!)">
            <mat-icon>{{ getStatusIcon(order?.Status!) }}</mat-icon>
            <span>{{ getStatusLabel(order?.Status!) }}</span>
        </div>
    </div>
    <p class="common-meta">
        Ordered On: {{ order?.Created | date:'short' }}<br />
        Customer: {{ order?.CustomerDetails?.FirstName + " " +  order?.CustomerDetails?.LastName }}<br/>
        Total: ${{ order?.TotalAmount }}
    </p>
    
    <!-- Order Items Section -->
    <div class="order-items" *ngIf="isExpanded">
        <h4>Items:</h4>
        <div *ngFor="let item of order?.OrderItems; let i = index" class="order-item-detail">
            <div class="item-header">
                <span class="item-title">{{ item.FormTitle || item.ProductName }}</span>
                <span class="item-price">${{ item.Price }}</span>
                <button mat-icon-button (click)="expandOrderItem(i)" 
                        *ngIf="item.IsExpandable" 
                        [attr.aria-label]="'Expand ' + item.ProductName">
                    <mat-icon>{{ expandedItems.has(i) ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
            </div>
            <p class="item-summary" *ngIf="item.FormSummary">{{ item.FormSummary }}</p>
            
            <!-- Expanded form data -->
            <div class="expanded-form-data" *ngIf="expandedItems.has(i) && expandedFormData.has(i)">
                <pre>{{ expandedFormData.get(i) | json }}</pre>
                <button mat-button color="primary" (click)="editOrderItem(i)">
                    <mat-icon>edit</mat-icon>
                    Edit Form
                </button>
            </div>
        </div>
    </div>
    
    <div class="order-actions">
        <button mat-button (click)="toggleExpand()">
            {{ isExpanded ? 'Collapse' : 'View Details' }}
        </button>
        
        <!-- TENANT ACTIONS -->
        <ng-container *ngIf="isTenantUser()">
            <!-- Tenant can process submitted orders -->
            <button mat-button color="primary" (click)="startProcessing()" *ngIf="canTenantProcess()">
                <mat-icon>work</mat-icon>
                Start Processing
            </button>
            
            <!-- Tenant can complete processing orders -->
            <button mat-button color="accent" (click)="markCompleted()" *ngIf="canTenantComplete()">
                <mat-icon>check_circle</mat-icon>
                Mark Completed
            </button>
            
            <!-- Tenant can reject submitted orders -->
            <button mat-button color="warn" (click)="rejectOrder()" *ngIf="canTenantReject()">
                <mat-icon>cancel</mat-icon>
                Reject
            </button>
            
            <!-- Read-only for tenants when order is completed/rejected -->
            <span *ngIf="order?.Status === OrderStatus.Completed || order?.Status === OrderStatus.Rejected" class="readonly-indicator">
                <mat-icon>visibility</mat-icon>
                View Only
            </span>
        </ng-container>
        
        <!-- CUSTOMER ACTIONS -->
        <ng-container *ngIf="!isTenantUser()">
            <!-- In-progress orders (Created status) -->
            <ng-container *ngIf="isInProgress()">
                <button mat-button color="primary" (click)="continueOrder()">
                    <mat-icon>play_arrow</mat-icon>
                    Continue
                </button>
            </ng-container>
            
            <!-- Submitted orders (but not yet paid) -->
            <ng-container *ngIf="isSubmitted()">
                <button mat-button color="primary" (click)="editOrder()">
                    <mat-icon>edit</mat-icon>
                    Edit
                </button>
                <button mat-button color="accent" (click)="addToCart()">
                    <mat-icon>add_shopping_cart</mat-icon>
                    Add to Cart
                </button>
            </ng-container>
            
            <!-- Delete button for customers (Created or Submitted) -->
            <button mat-button color="warn" (click)="deleteOrder()" *ngIf="canDelete()">
                <mat-icon>delete</mat-icon>
                Delete
            </button>
            
            <!-- Read-only orders for customers (Processing, Completed, Rejected) -->
            <span *ngIf="isReadOnly()" class="readonly-indicator">
                <mat-icon>lock</mat-icon>
                Read Only
            </span>
        </ng-container>
    </div>
</div>